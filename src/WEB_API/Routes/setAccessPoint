import { Express, Request, Response } from 'express';
import { logger } from "../../Logger/LoggerManager";
import * as fs from 'fs';

/*
    URL : /test
    METHODE : POST
    CORPS : {"id": 69}
    CONTENT-TYPE : application/json

    DESCRIPTION : test de la connexion
*/
module.exports = function(app: Express){
    app.post('/setAccessPoint', async (req: Request, res: Response) => {
        let data = req.body;
        
        if (data.ssid == null || typeof data.ssid != "string" || data.password == null || typeof data.password != "string") {
            res.status(400).send({"error": "Des arguments sont manquants et/ou incorrectes dans le corps de la requête."});
            return;
        }

        const ssid = data.ssid;
        const password = data.password;

        // Traite la requête
        try {
            // set the password and ssid of the current access point by reading/writing to the hostapd file for ssid and wpa_passphrase
            fs.readFile('/etc/hostapd/hostapd.conf', 'utf8', (err, data) => {
                if (err) {
                    res.status(400).send({"error": "Erreur lors de la lecture du fichier de configuration du point d'accès."});
                    return;
                }

                let lines = data.split('\n');
                let newLines: string[] = [];
                lines.forEach((line) => {
                    if (line.startsWith('ssid=')) {
                        newLines.push('ssid=' + ssid);
                    } else if (line.startsWith('wpa_passphrase=')) {
                        newLines.push('wpa_passphrase=' + password);
                    } else {
                        newLines.push(line);
                    }
                });
                fs.writeFile('/etc/hostapd/hostapd.conf', newLines.join('\n'), (err) => {
                    if (err) {
                        res.status(400).send({"error": "Erreur lors de l'écriture du fichier de configuration du point d'accès."});
                        return;
                    }
                    res.send({"success": true});
                });
            });
            
        } catch (error) {
            let message = 'Erreur inconnue'
            if (error instanceof Error) message = error.message
            res.status(400).send({"success": false, "error": message});
            return;
        }
    });
}

